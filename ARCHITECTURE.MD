
WipeDisk Enterprise

## 1. Общие принципы

Продукт строится на принципах **Clean Architecture** и **Security-by-Design**.

* **Изоляция платформы:** Весь код, специфичный для Windows API, инкапсулирован в `internal/system`.
* **Предсказуемость:** Никаких `panic()`. Любая ошибка должна быть обработана, залогирована и возвращена вызывающей стороне.
* **Zero-Trust I/O:** Мы не доверяем кэшированию ОС. Каждая запись должна быть подтверждена сбросом буферов (`Flush`/`Sync`).

---

## 2. Структура пакетов и ответственности

| Пакет | Зона ответственности | Ограничения |
| --- | --- | --- |
| `cmd/wipedisk` | Точка входа, парсинг флагов, инициализация UI. | **Запрещена** бизнес-логика и прямая работа с FS. |
| `internal/config` | Загрузка YAML/JSON, валидация путей и прав. | Не зависит от других пакетов. |
| `internal/wipe` | Engine: алгоритмы затирания, управление wipe-файлом. | Работает только через абстракции `system`. |
| `internal/maintenance` | Очистка системного мусора (Temp, Logs, Cache). | Использование реестра задач (Task Registry). |
| `internal/system` | Windows API, проверка прав админа, блокировка сна. | Низкоуровневый код (`golang.org/x/sys/windows`). |
| `internal/logging` | Структурированное логирование (Zap/Slog). | Формат JSON для Enterprise (SIEM). |

---

## 3. Протокол Wipe Engine (Решение бага №1)

Для исключения неэффективного затирания, процесс `WipeFreeSpace` строго следует этапам:

1. **Reservation:** Создание одного файла `wipe_reserve.tmp` с флагом `O_EXCL`.
2. **Saturation:** Циклическая запись паттерна буферами по 1MB до получения ошибки `ERROR_DISK_FULL`.
3. **Validation:** Вызов `f.Sync()` для принудительной записи из контроллера на диск.
4. **Finalization:** Закрытие дескриптора и удаление файла.

---

## 4. Стандарты безопасности (Security Standards)

* **Anti-Forensics:** Использование случайных данных (`crypto/rand`) вместо `math/rand` для предотвращения предсказания паттернов.
* **Memory Sanitization:** Стирание чувствительных данных (пути, ключи) из памяти после использования (по возможности).
* **Privilege Check:** При запуске обязательная проверка на права `SeManageVolumePrivilege` (необходимы для дефрагментации и глубокой очистки).

---

## 5. Модель Maintenance-задач

Все операции обслуживания должны реализовывать интерфейс `Task`:

```go
type Task interface {
    ID() string          // Уникальный ID (напр. "clean_dns_cache")
    Execute(ctx context.Context) error
    Estimate() string    // Оценка сложности/времени
}

```

Это позволит в v1.2.2 легко добавлять новые очистки (Chrome, Edge, Spotify Cache) без правки основного цикла программы.

---

## 6. Формат отчетов (Reporting)

Enterprise-отчет генерируется в конце каждой сессии:

* **Status:** `SUCCESS` / `PARTIAL_SUCCESS` / `FAILED`.
* **Metrics:** `TotalBytesWiped`, `Duration`, `ErrorsCount`.
* **Trace:** Список всех затронутых директорий и системных вызовов.

---

### Что это дает проекту:

1. **Чистота:** Мы удаляем дублирование функций `GetDiskInfo`. Теперь это живет только в `internal/system`.
2. **Стабильность:** Мы фиксируем, что `wipe` не удаляет файл, пока диск не заполнится.
3. **Масштабируемость:** Добавление очистки нового браузера — это просто создание нового файла в `internal/maintenance`.

